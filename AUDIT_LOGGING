# Audit Logging & Forensic Traceability

> **C√≥mo registrar cada acci√≥n para compliance, forensics y detecci√≥n de fraude**

---

## ¬øPor Qu√© Auditor√≠a?

### Los Problemas que Resuelve

**Problema 1: Compliance Legal**
Reguladores exigen: "Demostrar qui√©n hizo qu√©, cu√°ndo y por qu√©"

**Problema 2: Detecci√≥n de Fraude**
"Un cliente dice que nunca autoriz√≥ esa compra" ‚Üí Necesitas prueba de qui√©n lo hizo

**Problema 3: Debugging**
"El inventario desapareci√≥" ‚Üí Rastrear exactamente qu√© pas√≥

**Problema 4: Accountability**
"Alguien busc√≥ datos de otro tenant" ‚Üí Qui√©n fue y cu√°ndo

### La Soluci√≥n: Audit Log Completo

Cada acci√≥n cr√≠tica se registra permanentemente e inmutablemente.

---

## ¬øQu√© se Registra?

### Categor√≠a 1: Movimientos de Inventario

Cada vez que el stock cambia:

```
Usuario: admin@razo.com
Acci√≥n: Recibir orden de compra
Variante: Camiseta Rojo Talla M
Cantidad anterior: 100 unidades
Cantidad posterior: 150 unidades
Motivo: Orden de compra #5432 recibida
IP del usuario: 192.168.1.100
Fecha/hora: 2026-02-15 14:32:15 UTC
Tenant: Razo
```

### Categor√≠a 2: Cambios de Estado de Orden

Cuando una orden cambia de estado:

```
Usuario: sistema (autom√°tico)
Acci√≥n: Cambio de estado de orden
Orden: #2341
Estado anterior: "En Espera"
Estado posterior: "Surtida"
Raz√≥n: Stock fue reasignado por prioridad
Tenant: Razo
```

### Categor√≠a 3: Acciones de Usuario

Login, logout, cambio de permisos:

```
Usuario: admin@razo.com
Acci√≥n: Login
IP: 192.168.1.100
Navegador: Chrome
Resultado: Exitoso
Timestamp: 2026-02-15 14:32:15 UTC
```

### Categor√≠a 4: Accesos a Datos Sensibles

Vistas de informaci√≥n confidencial:

```
Usuario: admin@razo.com
Acci√≥n: Consultar historial de cr√©dito
Recurso: Cliente #5432
Motivo: Evaluaci√≥n de solicitud de cr√©dito
Timestamp: 2026-02-15 14:32:15 UTC
```

### Categor√≠a 5: Cambios de Configuraci√≥n

Modificaciones de setup:

```
Usuario: admin@razo.com
Acci√≥n: Cambiar tasa de inter√©s de cr√©dito
Valor anterior: 2.5%
Valor nuevo: 3.0%
Timestamp: 2026-02-15 14:32:15 UTC
```

---

## Propiedades del Audit Log

### Propiedad 1: Inmutable

Una vez que se registra, NO puede modificarse o borrarse.

**¬øC√≥mo se implementa?**
- Tablas de auditor√≠a son append-only
- No hay UPDATE ni DELETE permitidos
- Solo INSERT (agregar registros nuevos)

**Beneficio:** Incluso si alguien obtiene acceso a BD, no puede borrar evidencia

### Propiedad 2: Completo

NADA se escapa del registro.

**¬øC√≥mo se verifica?**
- Cada endpoint tiene middleware de auditor√≠a
- Si alguien intenta saltarse el middleware, falla el request
- Tests verifican que cada acci√≥n cr√≠tica est√° auditada

### Propiedad 3: Timestamped

Cada entrada tiene fecha/hora exacta (UTC, no local).

**¬øPor qu√© UTC?**
- Consistente globalmente
- No ambig√ºedad de zonas horarias
- Precisi√≥n a milisegundos

### Propiedad 4: Contextualizado

Cada entrada incluye contexto completo:
- Qui√©n (user_id)
- Qu√© (acci√≥n)
- Cu√°ndo (timestamp)
- D√≥nde (IP, navegador)
- Por qu√© (motivo/raz√≥n)
- Afectado (recurso_id)

### Propiedad 5: Tenant-Aislado

Cada log incluye tenant_id, as√≠ los datos de un tenant jam√°s se mezclan con otro.

---

## Casos de Uso: Forensics

### Caso 1: Cliente Reclama "No Autoric√© Esta Compra"

```
Cliente: "Yo nunca compr√© $5,000!"

Sistema busca en audit log:
Fecha: 2026-02-10 14:32:15 UTC
Usuario: admin@razo.com (admin de Razo)
Acci√≥n: Crear orden
Monto: $5,000
IP: 192.168.1.100 (Oficina de Razo)

Conclusi√≥n: 
- Admin de Razo cre√≥ la orden
- Desde IP de oficina
- A las 14:32 (horario laboral)

Cliente estaba confundido o minti√≥. Orden ES v√°lida.
```

---

### Caso 2: Inventario Discrepancia

```
¬øQu√© pas√≥ con 50 unidades de producto X?

Sistema busca audit log para producto X:
- 2026-02-01: Compra 100 unidades (stock: 0 ‚Üí 100)
- 2026-02-02: Venta 30 unidades (stock: 100 ‚Üí 70)
- 2026-02-03: Venta 20 unidades (stock: 70 ‚Üí 50)
- 2026-02-04: Ajuste -50 unidades (stock: 50 ‚Üí 0) ‚Üê SOSPECHOSO
  - Usuario: admin2@razo.com
  - Motivo: "Merma en bodega"
  - IP: 192.168.1.101

Investigaci√≥n:
- ¬øQui√©n es admin2? Empleado de 2 meses, acceso a bodega
- ¬øEs normal hacer ajuste de 50? No, usualmente <5
- ¬øSe report√≥ merma a supervisor? No hay registro

Conclusi√≥n: Posible robo. Investigar a admin2.
```

---

### Caso 3: Data Breach (¬øSe filtraron datos?)

```
Reportan: "Alguien vio datos de clientes de otro tenant!"

Sistema busca audit log con:
- Queries que accedieron a tabla "clientes"
- Filtrando por tenant_id incorrecto
- En el per√≠odo de tiempo sospechoso

Resultado: 0 queries encontradas

Conclusi√≥n: Data breach NO ocurri√≥ en RazoConnect. 
La brecha fue en otro lado (email comprometido, etc).
```

---

## Estad√≠sticas del Audit Log

### Volumen

```
RazoConnect genera aproximadamente:
- 500-1,000 log entries por d√≠a (por tenant peque√±o)
- 50,000+ log entries por d√≠a (por tenant grande)
- Total: ~1 mill√≥n entries al mes (en toda la plataforma)
```

### Retenci√≥n

```
Requerimiento legal: Conservar 7 a√±os
RazoConnect: Conserva indefinidamente (costo bajo de storage)

Tabla de auditor√≠a:
- Grow ~30MB/mes (por tenant)
- 7 a√±os = ~2.5GB
- Altamente compresible (text logs)
```

### Performance Impact

```
¬øCu√°nto ralentiza el logging?
- Operaci√≥n normal: 100ms
- Tiempo de logging: <1ms (as√≠ncrono)
- Performance impact: <1%

Conclusi√≥n: El logging es pr√°cticamente gratis en performance.
```

---

## Protecci√≥n del Audit Log

### Qui√©n puede Acceder?

```
Nivel 1 (Admin local):
- Puede ver logs de su tenant (solo)
- No puede ver logs de otros tenants
- No puede borrar logs

Nivel 2 (Super Admin):
- Puede ver todos los logs de toda la plataforma
- No puede borrar logs (inmutable)
- Debe autenticarse con 2FA

Nivel 3 (System):
- Completo acceso a archivos de log
- Pero tabla de BD es append-only (inmutable)
```

### C√≥mo se Protege contra Tampering?

```
T√©cnica 1: Append-Only Table
- No hay UPDATE permitido en tabla de auditor√≠a
- No hay DELETE permitido
- Solo INSERT
- PostgreSQL role-based access control lo enforce

T√©cnica 2: Separaci√≥n de Datos
- Audit log en tabla separada
- No integrado con tablas normales
- Si alguien hace TRUNCATE en tablas normales, audit log sigue intacto

T√©cnica 3: Backup Separado
- Backups de audit log son independientes
- Retenido separadamente por 7 a√±os
- Incluso si alguien borra BD, backup sigue siendo legal evidence

T√©cnica 4: Hash Verification (Opcional)
- Cada log entry tiene hash del anterior
- Si alguien modifica un entry, hash chain se rompe
- Detectable inmediatamente
```

---

## üìà Auditor√≠a Peri√≥dica

### Auditor√≠a Semanal (Autom√°tica)

Sistema genera reporte:
```
Semana del 2026-02-09:
- Total log entries: 15,432
- Intentos de acceso fallidos: 3
- √ìrdenes creadas/modificadas: 234
- Cambios de permisos: 0
- Accesos a datos sensibles: 12
```

### Auditor√≠a Mensual (Manual)

Admin de Razo revisa:
- Cambios de configuraci√≥n inusuales
- Accesos fuera de horario
- Discrepancias de inventario grandes
- Transacciones sospechosas

### Auditor√≠a Anual (Externa)

Auditor externo:
- Verifica integridad del audit log
- Revisa sample de entries
- Verifica que nada fue borrado
- Genera certificado de compliance

---

## Decisiones de Dise√±o

### ¬øPor Qu√© Append-Only?

**Raz√≥n 1: Cumplimiento Legal**
Reguladores exigen que logs NO puedan ser modificados. Append-only lo guarantee.

**Raz√≥n 2: Forensic Evidence**
En corte, si demuestras que logs no pueden ser modificados, es evidencia aceptable.

**Raz√≥n 3: Simplicidad**
Append-only es m√°s simple que versioning. No hay riesgo de inconsistencia.

---

### ¬øPor Qu√© As√≠ncrono?

El logging es **as√≠ncrono** (no bloquea la transacci√≥n principal):

```
Usuario hace acci√≥n
‚Üì
Acci√≥n se procesa (100ms)
‚Üì
Sistema enqueue log entry en cola
‚Üì
Response al usuario (inmediata)
‚Üì
[En background] Log entry se escribe a BD (2-5ms despu√©s)
```

**Ventaja:** No ralentiza operaciones al usuario

**Desventaja:** En casos raros, si app crash, log entry se pierde (pero es raro)

**Trade-off:** Vale la pena porque user experience es cr√≠tico

---

## Ejemplos de Logs Reales

### Log 1: Movimiento de Inventario

```json
{
  "log_id": 451234,
  "timestamp": "2026-02-15T14:32:15Z",
  "tenant_id": 1,
  "user_id": 5,
  "username": "admin@razo.com",
  "action": "inventory_adjustment",
  "resource_type": "variant",
  "resource_id": 342,
  "product_name": "Camiseta Rojo M",
  "change_type": "increase",
  "quantity_before": 100,
  "quantity_after": 150,
  "reason": "Orden de compra #5432",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0...",
  "status": "success"
}
```

### Log 2: Cambio de Orden

```json
{
  "log_id": 451235,
  "timestamp": "2026-02-15T14:32:20Z",
  "tenant_id": 1,
  "user_id": null,
  "username": "system",
  "action": "order_status_change",
  "resource_type": "order",
  "resource_id": 2341,
  "status_before": "en_espera",
  "status_after": "surtida",
  "reason": "stock_reallocated_by_priority",
  "affected_client_id": 567,
  "ip_address": null,
  "status": "success"
}
```

---

## Lecciones Aprendidas

### Lecci√≥n 1: Audit Desde el Inicio

Si la agregas despu√©s, tienes 2 problemas:
- C√≥digo existente no tiene auditor√≠a
- No puedes auditar acciones pasadas

Desde el inicio es 10x m√°s f√°cil.

### Lecci√≥n 2: As√≠ncrono es Mejor

Si el logging bloquea el request, los usuarios lo notan y se quejan. Hazlo as√≠ncrono.

### Lecci√≥n 3: Contexto Completo Importa

Logs sin contexto son in√∫tiles.
"User hizo acci√≥n" ‚Üí Qui√©n, cu√°ndo, d√≥nde, por qu√©?

Contexto completo = Forensics √∫til.

### Lecci√≥n 4: Protege el Log Mismo

Si cualquiera puede modificar los logs, el sistema es in√∫til. Append-only + access control lo protege.

---

## Conclusi√≥n

El Audit System de RazoConnect:

‚úÖ **Completo:** Registra todas las acciones cr√≠ticas  
‚úÖ **Inmutable:** No puede ser modificado  
‚úÖ **Contextualizado:** Incluye contexto completo  
‚úÖ **Performante:** <1% impacto en performance  
‚úÖ **Legal:** Cumple regulaciones de compliance  

**El secreto:** Auditor√≠a append-only + contexto completo + segregaci√≥n por tenant = Forensics poderosa.
