# Database Design & Schema Architecture

> **CÃ³mo diseÃ±ar una base de datos que soporte mÃºltiples tenants, auditorÃ­a, complejas validaciones y escalabilidad**

---

## ğŸ“Š Arquitectura de Tablas

RazoConnect utiliza **20+ tablas** organizadas en 5 dominios:

```
DOMINIO 1: TENANTS & USUARIOS
â”œâ”€â”€ tenants (clientes de la plataforma)
â””â”€â”€ usuarios (admins, agentes, viewers)

DOMINIO 2: CATÃLOGO
â”œâ”€â”€ productos
â”œâ”€â”€ producto_variantes
â”œâ”€â”€ categorias
â””â”€â”€ proveedores

DOMINIO 3: INVENTARIO
â”œâ”€â”€ inventarios_admin (stock por admin/bodega)
â”œâ”€â”€ stock_admin (stock consolidado)
â”œâ”€â”€ movimientos_inventario (Kardex append-only)
â””â”€â”€ sesiones_inventario (conteos periÃ³dicos)

DOMINIO 4: VENTAS & CRÃ‰DITO
â”œâ”€â”€ clientes
â”œâ”€â”€ cliente_creditos
â”œâ”€â”€ pedidos
â”œâ”€â”€ detalles_del_pedido
â”œâ”€â”€ solicitudes_credito
â””â”€â”€ devoluciones

DOMINIO 5: Ã“RDENES DE COMPRA
â”œâ”€â”€ ordenesdecompra
â”œâ”€â”€ detalles_oc_proveedor
â””â”€â”€ remisiones

DOMINIO 6: AUDITORÃA & LOGS
â”œâ”€â”€ audit_log (append-only)
â”œâ”€â”€ notificaciones
â”œâ”€â”€ errores_sincronizacion
â””â”€â”€ landing_config
```

## Funciones PL/pgSQL Especializadas

RazoConnect implementa **20+ funciones** en la BD para lÃ³gica crÃ­tica:

### **Funciones de Deuda**

**actualizar_estatus_deuda_vencida()**
- Diariamente (via pg_cron) actualiza quÃ© deudas estÃ¡n vencidas
- Calcula dÃ­as de atraso automÃ¡ticamente
- Si deuda > 15 dÃ­as, suspende cliente

**trigger_actualizar_estatus_deuda()**
- Se dispara al cambiar fecha de vencimiento
- AutomÃ¡ticamente marca como VENCIDA si fecha < hoy
- Se dispara al pagar, reseteando deuda a PAGADA

---

### **Funciones de Inventario**

**get_stock_admin(admin_id, variante_id)**
- Consulta rÃ¡pida: Â¿cuÃ¡nto stock tiene este admin?
- Usado en validaciones de asignaciÃ³n

**upsert_inventario_admin(admin_id, variante_id, cantidad)**
- Inserta o incrementa stock
- Usa INSERT ... ON CONFLICT ... DO UPDATE
- Garantiza consistencia si hay race conditions

**sync_producto_variante_stock()**
- Trigger que se dispara cada vez que cambia inventarios_admin
- AutomÃ¡ticamente recalcula producto_variantes.stock
- Mantiene sincronizaciÃ³n entre tablas

**fn_validar_movimiento_inventario()**
- Trigger que valida cada movimiento
- Verifica que stock_posterior = stock_previo Â± cantidad
- Previene inconsistencias matemÃ¡ticas

---

### **Funciones de Ã“rdenes**

**recalcular_total_pedido()**
- Trigger que se dispara al cambiar detalles de pedido
- Recalcula monto total sumando todos los items
- DETECTA discrepancias sin modificar automÃ¡ticamente
- Registra en tabla "errores_sincronizacion" si hay problema
- Previene corrupciÃ³n de datos financieros

**validar_agrupacion_ordenes(orden_ids[])**
- FunciÃ³n que valida si Ã³rdenes pueden agruparse
- Verifica que todas sean del mismo proveedor
- Devuelve validez + proveedor comÃºn + mensaje

---

### **Funciones de Devoluciones**

**calcular_monto_total_devolucion(devolucion_id)**
- Suma todos los detalles de devoluciÃ³n
- Resultado se guarda en tabla devoluciones
- AutomÃ¡tico via trigger

**validar_cantidad_devuelta()**
- Trigger que verifica no devuelves mÃ¡s de lo que compraste
- Suma devoluciones previas
- Evita "devolver mÃ¡s que la cantidad original"

---

### **Funciones Auxiliares**

**generar_folio_remision(tenant_id)**
- Genera folio Ãºnico: REM-2026-00001
- Usa tenant_id para aislar por cliente
- AutomÃ¡ticamente incrementa consecutivo

**obtener_siguiente_sku(categoria_id)**
- Genera SKU Ãºnico: CAJ-001, CAJ-002, etc
- Basado en nombre de categorÃ­a (3 primeras letras)
- Previene duplicados

**suspender_clientes_morosos()**
- Job que corre diariamente (pg_cron)
- Suspende clientes con deuda > 15 dÃ­as
- Bloquea nuevo crÃ©dito automÃ¡ticamente

---

## ğŸ“Š Diagrama Entidad-RelaciÃ³n (ER)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           RAZOCONNECT DATABASE                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚    tenants      â”‚
                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                              â”‚ tenant_id (PK)  â”‚
                              â”‚ nombre          â”‚
                              â”‚ dominio (UQ)    â”‚
                              â”‚ is_active       â”‚
                              â”‚ plan            â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                  â”‚                  â”‚
                    â–¼                  â–¼                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    usuarios      â”‚  â”‚    clientes      â”‚  â”‚    productos     â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚ usuario_id (PK)  â”‚  â”‚ cliente_id (PK)  â”‚  â”‚ producto_id (PK) â”‚
         â”‚ tenant_id (FK)   â”‚  â”‚ tenant_id (FK)   â”‚  â”‚ tenant_id (FK)   â”‚
         â”‚ email (UQ)       â”‚  â”‚ email            â”‚  â”‚ nombre           â”‚
         â”‚ rol              â”‚  â”‚ credito_disp     â”‚  â”‚ precio_unitario  â”‚
         â”‚ is_active        â”‚  â”‚ historial_compra â”‚  â”‚ proveedor_id(FK) â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚                     â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                        â”‚               â”‚                 â”‚   â”‚
                        â–¼               â–¼                 â–¼   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  cliente_creditos    â”‚  â”‚    pedidos       â”‚ â”‚ producto_variantes
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚ credito_id (PK)      â”‚  â”‚ pedido_id (PK)   â”‚ â”‚ variante_id (PK) â”‚
         â”‚ cliente_id (FK)      â”‚  â”‚ tenant_id (FK)   â”‚ â”‚ producto_id (FK) â”‚
         â”‚ tenant_id (FK)       â”‚  â”‚ cliente_id (FK)  â”‚ â”‚ tenant_id (FK)   â”‚
         â”‚ estado_credito       â”‚  â”‚ estatus          â”‚ â”‚ sku (UQ)         â”‚
         â”‚ deuda_vencida        â”‚  â”‚ es_prioritario    â”‚ â”‚ precio_unitario  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ monto_total      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚ es_credito       â”‚         â”‚
                                    â”‚ estatus_deuda    â”‚         â”‚
                                    â”‚ dias_atraso      â”‚         â–¼
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                             â”‚           â”‚ inventarios_adminâ”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                    â”‚                 â”‚  â”‚ stock_id (PK)    â”‚
                                    â–¼                 â–¼  â”‚ admin_id (FK)    â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ variante_id (FK) â”‚
                        â”‚ detalles_del_pedido          â”‚ â”‚ tenant_id (FK)   â”‚
                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ cantidad         â”‚
                        â”‚ detalle_id (PK)              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ pedido_id (FK)               â”‚          â”‚
                        â”‚ variante_id (FK)             â”‚          â”‚
                        â”‚ tenant_id (FK)               â”‚          â–¼
                        â”‚ cantidad_paquetes             â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ piezas_por_paquete           â”‚ â”‚movimientos_invnt â”‚
                        â”‚ cantidad_surtida             â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                        â”‚ cantidad_backorder           â”‚ â”‚movimiento_id(PK) â”‚
                        â”‚ es_backorder                 â”‚ â”‚variante_id (FK)  â”‚
                        â”‚ precio_unitario              â”‚ â”‚ cantidad         â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ stock_anterior   â”‚
                                    â”‚                    â”‚ stock_posterior  â”‚
                                    â”‚                    â”‚ tipo             â”‚
                                    â”‚                    â”‚(APPEND-ONLY TABLE)
                                    â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                          â”‚
                        â–¼                          â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ ordenesdecompra          â”‚ â”‚ devoluciones             â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚ ordencompra_id (PK)      â”‚ â”‚ devolucion_id (PK)       â”‚
         â”‚ tenant_id (FK)           â”‚ â”‚ pedido_id (FK)           â”‚
         â”‚ proveedor_id (FK)        â”‚ â”‚ cliente_id (FK)          â”‚
         â”‚ estatus                  â”‚ â”‚ tenant_id (FK)           â”‚
         â”‚ fecha_entrega_estimada   â”‚ â”‚ estado                   â”‚
         â”‚ monto_total              â”‚ â”‚ monto_total (CALC)       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚                         â”‚
                     â–¼                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ detalles_oc_proveedor    â”‚ â”‚ devoluciones_detalles    â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚ detalle_oc_id (PK)       â”‚ â”‚ detalle_dev_id (PK)      â”‚
         â”‚ oc_id (FK)               â”‚ â”‚ devolucion_id (FK)       â”‚
         â”‚ variante_id (FK)         â”‚ â”‚ detalle_pedido_id (FK)   â”‚
         â”‚ cantidad_paquetes        â”‚ â”‚ cantidad_paquetes        â”‚
         â”‚ cantidad_recibida        â”‚ â”‚ subtotal                 â”‚
         â”‚ cantidad_diferencia      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚ audit_log        â”‚
                                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                â”‚ log_id (PK)      â”‚
                                â”‚ tenant_id (FK)   â”‚
                                â”‚ usuario_id (FK)  â”‚
                                â”‚ accion           â”‚
                                â”‚ recurso_tipo     â”‚
                                â”‚ cambios (JSON)   â”‚
                                â”‚ timestamp        â”‚
                                â”‚(APPEND-ONLY)     â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LEYENDA:
  PK = Primary Key (clave Ãºnica de tabla)
  FK = Foreign Key (referencia a otra tabla)
  UQ = Unique (no puede haber duplicados)
  CALC = Campo calculado automÃ¡ticamente por trigger
  APPEND-ONLY = No se puede modificar ni borrar

RELACIONES PRINCIPALES:
  â€¢ tenants â† â†’ usuarios, clientes, productos
  â€¢ productos â† â†’ producto_variantes
  â€¢ producto_variantes â† â†’ inventarios_admin, movimientos_inventario
  â€¢ clientes â† â†’ pedidos, cliente_creditos
  â€¢ pedidos â† â†’ detalles_del_pedido, devoluciones
  â€¢ detalles_del_pedido â† â†’ devoluciones_detalles
  â€¢ ordenesdecompra â† â†’ detalles_oc_proveedor
  â€¢ TODO â† â†’ audit_log (cada tabla es auditada)
```

## ğŸ”„ Triggers AutomÃ¡ticos

RazoConnect tiene 10+ triggers que se disparan automÃ¡ticamente:

| Trigger | Se Dispara | AcciÃ³n |
|---------|-----------|--------|
| `actualizar_timestamp_inventario` | UPDATE en inventarios_admin | Actualiza `ultima_actualizacion` |
| `sync_producto_variante_stock` | INSERT/UPDATE/DELETE en inventarios_admin | Sincroniza stock total |
| `fn_validar_movimiento_inventario` | INSERT en movimientos_inventario | Valida consistencia ACID |
| `recalcular_total_pedido` | INSERT/UPDATE/DELETE en detalles_del_pedido | Valida totales |
| `actualizar_timestamp_devolucion` | UPDATE en devoluciones | Actualiza timestamp |
| `actualizar_monto_total_devolucion` | INSERT/UPDATE en devoluciones_detalles | Recalcula monto |
| `validar_cantidad_devuelta` | INSERT/UPDATE en devoluciones_detalles | Valida no exceda cantidad original |
| `trigger_actualizar_estatus_deuda` | UPDATE en pedidos | Actualiza deuda vencida |
| `limitar_notificaciones_por_cliente` | INSERT en notificaciones | Limpia a 100 Ãºltimas |

## ConclusiÃ³n

El Database Design de RazoConnect:

âœ… **Normalizado:** 3NF + desnormalizaciÃ³n inteligente  
âœ… **Multi-tenant:** tenant_id en cada tabla crÃ­tica  
âœ… **Auditado:** Kardex append-only + audit_log  
âœ… **Validado:** 10+ triggers para integridad ACID  
âœ… **Optimizado:** 30+ Ã­ndices estratÃ©gicos  
âœ… **Automatizado:** 10+ funciones PL/pgSQL especializadas  
âœ… **Escalable:** Soporta mÃºltiples tenants simultÃ¡neamente  

**El secreto:** NormalizaciÃ³n + desnormalizaciÃ³n inteligente + triggers automÃ¡ticos + append-only auditing = Base de datos enterprise-grade que **se valida a sÃ­ misma**.
