# Audit Logging & Forensic Traceability

> **CÃ³mo registrar cada acciÃ³n para compliance, forensics y detecciÃ³n de fraude**

---

## ğŸ¯ Â¿Por QuÃ© AuditorÃ­a?

### Los Problemas que Resuelve

**Problema 1: Compliance Legal**
Reguladores exigen: "Demostrar quiÃ©n hizo quÃ©, cuÃ¡ndo y por quÃ©"

**Problema 2: DetecciÃ³n de Fraude**
"Un cliente dice que nunca autorizÃ³ esa compra" â†’ Necesitas prueba de quiÃ©n lo hizo

**Problema 3: Debugging**
"El inventario desapareciÃ³" â†’ Rastrear exactamente quÃ© pasÃ³

**Problema 4: Accountability**
"Alguien buscÃ³ datos de otro tenant" â†’ QuiÃ©n fue y cuÃ¡ndo

### La SoluciÃ³n: Audit Log Completo

Cada acciÃ³n crÃ­tica se registra permanentemente e inmutablemente.

---

## ğŸ“‹ Â¿QuÃ© se Registra?

### CategorÃ­a 1: Movimientos de Inventario

Cada vez que el stock cambia:

```
Usuario: admin@razo.com
AcciÃ³n: Recibir orden de compra
Variante: Camiseta Rojo Talla M
Cantidad anterior: 100 unidades
Cantidad posterior: 150 unidades
Motivo: Orden de compra #5432 recibida
IP del usuario: 192.168.1.100
Fecha/hora: 2026-02-15 14:32:15 UTC
Tenant: Razo
```

### CategorÃ­a 2: Cambios de Estado de Orden

Cuando una orden cambia de estado:

```
Usuario: sistema (automÃ¡tico)
AcciÃ³n: Cambio de estado de orden
Orden: #2341
Estado anterior: "En Espera"
Estado posterior: "Surtida"
RazÃ³n: Stock fue reasignado por prioridad
Tenant: Razo
```

### CategorÃ­a 3: Acciones de Usuario

Login, logout, cambio de permisos:

```
Usuario: admin@razo.com
AcciÃ³n: Login
IP: 192.168.1.100
Navegador: Chrome
Resultado: Exitoso
Timestamp: 2026-02-15 14:32:15 UTC
```

### CategorÃ­a 4: Accesos a Datos Sensibles

Vistas de informaciÃ³n confidencial:

```
Usuario: admin@razo.com
AcciÃ³n: Consultar historial de crÃ©dito
Recurso: Cliente #5432
Motivo: EvaluaciÃ³n de solicitud de crÃ©dito
Timestamp: 2026-02-15 14:32:15 UTC
```

### CategorÃ­a 5: Cambios de ConfiguraciÃ³n

Modificaciones de setup:

```
Usuario: admin@razo.com
AcciÃ³n: Cambiar tasa de interÃ©s de crÃ©dito
Valor anterior: 2.5%
Valor nuevo: 3.0%
Timestamp: 2026-02-15 14:32:15 UTC
```

---

## ğŸ”’ Propiedades del Audit Log

### Propiedad 1: Inmutable

Una vez que se registra, NO puede modificarse o borrarse.

**Â¿CÃ³mo se implementa?**
- Tablas de auditorÃ­a son append-only
- No hay UPDATE ni DELETE permitidos
- Solo INSERT (agregar registros nuevos)

**Beneficio:** Incluso si alguien obtiene acceso a BD, no puede borrar evidencia

### Propiedad 2: Completo

NADA se escapa del registro.

**Â¿CÃ³mo se verifica?**
- Cada endpoint tiene middleware de auditorÃ­a
- Si alguien intenta saltarse el middleware, falla el request
- Tests verifican que cada acciÃ³n crÃ­tica estÃ¡ auditada

### Propiedad 3: Timestamped

Cada entrada tiene fecha/hora exacta (UTC, no local).

**Â¿Por quÃ© UTC?**
- Consistente globalmente
- No ambigÃ¼edad de zonas horarias
- PrecisiÃ³n a milisegundos

### Propiedad 4: Contextualizado

Cada entrada incluye contexto completo:
- QuiÃ©n (user_id)
- QuÃ© (acciÃ³n)
- CuÃ¡ndo (timestamp)
- DÃ³nde (IP, navegador)
- Por quÃ© (motivo/razÃ³n)
- Afectado (recurso_id)

### Propiedad 5: Tenant-Aislado

Cada log incluye tenant_id, asÃ­ los datos de un tenant jamÃ¡s se mezclan con otro.

---

## ğŸ” Casos de Uso: Forensics

### Caso 1: Cliente Reclama "No AutoricÃ© Esta Compra"

```
Cliente: "Yo nunca comprÃ© $5,000!"

Sistema busca en audit log:
Fecha: 2026-02-10 14:32:15 UTC
Usuario: admin@razo.com (admin de Razo)
AcciÃ³n: Crear orden
Monto: $5,000
IP: 192.168.1.100 (Oficina de Razo)

ConclusiÃ³n: 
- Admin de Razo creÃ³ la orden
- Desde IP de oficina
- A las 14:32 (horario laboral)

Cliente estaba confundido o mintiÃ³. Orden ES vÃ¡lida.
```

---

### Caso 2: Inventario Discrepancia

```
Â¿QuÃ© pasÃ³ con 50 unidades de producto X?

Sistema busca audit log para producto X:
- 2026-02-01: Compra 100 unidades (stock: 0 â†’ 100)
- 2026-02-02: Venta 30 unidades (stock: 100 â†’ 70)
- 2026-02-03: Venta 20 unidades (stock: 70 â†’ 50)
- 2026-02-04: Ajuste -50 unidades (stock: 50 â†’ 0) â† SOSPECHOSO
  - Usuario: admin2@razo.com
  - Motivo: "Merma en bodega"
  - IP: 192.168.1.101

InvestigaciÃ³n:
- Â¿QuiÃ©n es admin2? Empleado de 2 meses, acceso a bodega
- Â¿Es normal hacer ajuste de 50? No, usualmente <5
- Â¿Se reportÃ³ merma a supervisor? No hay registro

ConclusiÃ³n: Posible robo. Investigar a admin2.
```

---

### Caso 3: Data Breach (Â¿Se filtraron datos?)

```
Reportan: "Alguien vio datos de clientes de otro tenant!"

Sistema busca audit log con:
- Queries que accedieron a tabla "clientes"
- Filtrando por tenant_id incorrecto
- En el perÃ­odo de tiempo sospechoso

Resultado: 0 queries encontradas

ConclusiÃ³n: Data breach NO ocurriÃ³ en RazoConnect. 
La brecha fue en otro lado (email comprometido, etc).
```

---

## ğŸ“Š EstadÃ­sticas del Audit Log

### Volumen

```
RazoConnect genera aproximadamente:
- 500-1,000 log entries por dÃ­a (por tenant pequeÃ±o)
- 50,000+ log entries por dÃ­a (por tenant grande)
- Total: ~1 millÃ³n entries al mes (en toda la plataforma)
```

### RetenciÃ³n

```
Requerimiento legal: Conservar 7 aÃ±os
RazoConnect: Conserva indefinidamente (costo bajo de storage)

Tabla de auditorÃ­a:
- Grow ~30MB/mes (por tenant)
- 7 aÃ±os = ~2.5GB
- Altamente compresible (text logs)
```

### Performance Impact

```
Â¿CuÃ¡nto ralentiza el logging?
- OperaciÃ³n normal: 100ms
- Tiempo de logging: <1ms (asÃ­ncrono)
- Performance impact: <1%

ConclusiÃ³n: El logging es prÃ¡cticamente gratis en performance.
```

---

## ğŸ” ProtecciÃ³n del Audit Log

### QuiÃ©n puede Acceder?

```
Nivel 1 (Admin local):
- Puede ver logs de su tenant (solo)
- No puede ver logs de otros tenants
- No puede borrar logs

Nivel 2 (Super Admin):
- Puede ver todos los logs de toda la plataforma
- No puede borrar logs (inmutable)
- Debe autenticarse con 2FA

Nivel 3 (System):
- Completo acceso a archivos de log
- Pero tabla de BD es append-only (inmutable)
```

### CÃ³mo se Protege contra Tampering?

```
TÃ©cnica 1: Append-Only Table
- No hay UPDATE permitido en tabla de auditorÃ­a
- No hay DELETE permitido
- Solo INSERT
- PostgreSQL role-based access control lo enforce

TÃ©cnica 2: SeparaciÃ³n de Datos
- Audit log en tabla separada
- No integrado con tablas normales
- Si alguien hace TRUNCATE en tablas normales, audit log sigue intacto

TÃ©cnica 3: Backup Separado
- Backups de audit log son independientes
- Retenido separadamente por 7 aÃ±os
- Incluso si alguien borra BD, backup sigue siendo legal evidence

TÃ©cnica 4: Hash Verification (Opcional)
- Cada log entry tiene hash del anterior
- Si alguien modifica un entry, hash chain se rompe
- Detectable inmediatamente
```

---

## ğŸ“ˆ AuditorÃ­a PeriÃ³dica

### AuditorÃ­a Semanal (AutomÃ¡tica)

Sistema genera reporte:
```
Semana del 2026-02-09:
- Total log entries: 15,432
- Intentos de acceso fallidos: 3
- Ã“rdenes creadas/modificadas: 234
- Cambios de permisos: 0
- Accesos a datos sensibles: 12
```

### AuditorÃ­a Mensual (Manual)

Admin de Razo revisa:
- Cambios de configuraciÃ³n inusuales
- Accesos fuera de horario
- Discrepancias de inventario grandes
- Transacciones sospechosas

### AuditorÃ­a Anual (Externa)

Auditor externo:
- Verifica integridad del audit log
- Revisa sample de entries
- Verifica que nada fue borrado
- Genera certificado de compliance

---

## ğŸ’¡ Decisiones de DiseÃ±o

### Â¿Por QuÃ© Append-Only?

**RazÃ³n 1: Cumplimiento Legal**
Reguladores exigen que logs NO puedan ser modificados. Append-only lo guarantee.

**RazÃ³n 2: Forensic Evidence**
En corte, si demuestras que logs no pueden ser modificados, es evidencia aceptable.

**RazÃ³n 3: Simplicidad**
Append-only es mÃ¡s simple que versioning. No hay riesgo de inconsistencia.

---

### Â¿Por QuÃ© AsÃ­ncrono?

El logging es **asÃ­ncrono** (no bloquea la transacciÃ³n principal):

```
Usuario hace acciÃ³n
â†“
AcciÃ³n se procesa (100ms)
â†“
Sistema enqueue log entry en cola
â†“
Response al usuario (inmediata)
â†“
[En background] Log entry se escribe a BD (2-5ms despuÃ©s)
```

**Ventaja:** No ralentiza operaciones al usuario

**Desventaja:** En casos raros, si app crash, log entry se pierde (pero es raro)

**Trade-off:** Vale la pena porque user experience es crÃ­tico

---

## ğŸ“‹ Ejemplos de Logs Reales

### Log 1: Movimiento de Inventario

```json
{
  "log_id": 451234,
  "timestamp": "2026-02-15T14:32:15Z",
  "tenant_id": 1,
  "user_id": 5,
  "username": "admin@razo.com",
  "action": "inventory_adjustment",
  "resource_type": "variant",
  "resource_id": 342,
  "product_name": "Camiseta Rojo M",
  "change_type": "increase",
  "quantity_before": 100,
  "quantity_after": 150,
  "reason": "Orden de compra #5432",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0...",
  "status": "success"
}
```

### Log 2: Cambio de Orden

```json
{
  "log_id": 451235,
  "timestamp": "2026-02-15T14:32:20Z",
  "tenant_id": 1,
  "user_id": null,
  "username": "system",
  "action": "order_status_change",
  "resource_type": "order",
  "resource_id": 2341,
  "status_before": "en_espera",
  "status_after": "surtida",
  "reason": "stock_reallocated_by_priority",
  "affected_client_id": 567,
  "ip_address": null,
  "status": "success"
}
```

---

## ğŸ“ Lecciones Aprendidas

### LecciÃ³n 1: Audit Desde el Inicio

Si la agregas despuÃ©s, tienes 2 problemas:
- CÃ³digo existente no tiene auditorÃ­a
- No puedes auditar acciones pasadas

Desde el inicio es 10x mÃ¡s fÃ¡cil.

### LecciÃ³n 2: AsÃ­ncrono es Mejor

Si el logging bloquea el request, los usuarios lo notan y se quejan. Hazlo asÃ­ncrono.

### LecciÃ³n 3: Contexto Completo Importa

Logs sin contexto son inÃºtiles.
"User hizo acciÃ³n" â†’ QuiÃ©n, cuÃ¡ndo, dÃ³nde, por quÃ©?

Contexto completo = Forensics Ãºtil.

### LecciÃ³n 4: Protege el Log Mismo

Si cualquiera puede modificar los logs, el sistema es inÃºtil. Append-only + access control lo protege.

---

## ğŸ¯ ConclusiÃ³n

El Audit System de RazoConnect:

âœ… **Completo:** Registra todas las acciones crÃ­ticas  
âœ… **Inmutable:** No puede ser modificado  
âœ… **Contextualizado:** Incluye contexto completo  
âœ… **Performante:** <1% impacto en performance  
âœ… **Legal:** Cumple regulaciones de compliance  

**El secreto:** AuditorÃ­a append-only + contexto completo + segregaciÃ³n por tenant = Forensics poderosa.
